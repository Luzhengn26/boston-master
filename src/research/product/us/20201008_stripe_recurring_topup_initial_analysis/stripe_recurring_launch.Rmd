---
title: "Stripe Recurring Topup Feature Release Analysis"
author: "Dani Mermelstein"
date: "2020-10-14"
region: "US"
summary: "Subsequent (AKA Recurring) TopUp program total revenue is $22k (best-base scenario), and total cost is $31k (below our initial $50k budget). It’s possible Stripe recurring topup gets more people to deposit more money but doesn’t get them to stay MAU longer. It’s possible the presence of Stripe recurring topup has increased the overall Signup -> FT MAU rate by 12% (from 14% to 15.6% within 14 days of signup). For users who used TopUp, it’s possible Stripe recurring topup has increased total deposits per user within 14 days of KYC Complete by 47% (from $176 to $260). For all users, total deposits within 14 days of KYC Complete might have decreased by 28% (statistical test results were inconclusive). Recurring Stripe TopUp appears to have no impact on 8-week lapse rates. Overall, recurring TopUp transactions are ~4 points riskier than first topup transactions (average of 17.7 vs 13.4 out of 100 points). Recurring topups are probably costing us about $3,000 per month. This best-case scenario analysis assumes all deposits are spent via cards and we benefit from 0.83% in interchange revenue, plus the 1% fee we currently charge. We incorporate stripe/network, dispute loss and dispute fees into the costs. We only factor in confirmed fraud but not potential fraud."
tags: "pre/post test, lapse rate, incremental funding, funding amounts, stripe, recurring topup, risk scores, transactions"
link: 
output: 
  html_document:
    toc: TRUE
    theme: cosmo
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(scales)
library(kableExtra)
library(tidyverse)
library(bayesAB)
library(ggplot2)

# load the data
load(paste0("data/stripe_data.RData"))

# aggregate to get some basic TopUp volume numbers
user_transactions[num>0, .(txn_cnt=.N, 
                           user_cnt=length(unique(user_id)), 
                           txn_amount=sum(txn_amount), 
                           avg_txn_amount=mean(txn_amount),
                           med_txn_amount=median(txn_amount)), 
                  by=.(topup_type, txn_month)][order(txn_month, topup_type),]

# https://stackoverflow.com/questions/4787332/how-to-remove-outliers-from-a-dataset
# here we're going to remove the top 2% of outliers
remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(0, .98), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- 0
  y[x > (qnt[2] + H)] <- 0
  y
}

```

# TL;DR

Subsequent (AKA Recurring) TopUp program total revenue is $22k (best-base scenario), and total cost is $31k (below our initial $50k budget). It’s possible Stripe recurring topup gets more people to deposit more money but doesn’t get them to stay MAU longer. 

 - It's possible the presence of Stripe recurring topup has increased the overall Signup -> FT MAU rate by 12% (from 14% to 15.6% within 14 days of signup)
 - For users who used TopUp, it's possible Stripe recurring topup has increased total deposits per user within 14 days of KYC Complete by 47% (from `r dollar(176)` to `r dollar(260)`)
 - For all users, total deposits within 14 days of KYC Complete might have decreased by 28% (statistical test results were inconclusive)
 - Recurring Stripe TopUp appears to have no impact on 8-week lapse rates
 - Overall, recurring TopUp transactions are ~4 points riskier than first topup transactions (average of 17.7 vs 13.4 out of 100 points)

Recurring topups are probably costing us about `r dollar(3000)` per month. This best-case scenario analysis assumes all deposits are spent via cards and we benefit from 0.83% in interchange revenue, plus the 1% fee we currently charge. We incorporate stripe/network, dispute loss and dispute fees into the costs. We only factor in confirmed fraud but not potential fraud.

For more detail on the dollar cost and revenue of running this feature so far, see [this document](https://docs.google.com/spreadsheets/d/1mydy67256PEe1AFBGTr7dD0x2-TYs-1V/edit#gid=643625962).

## Recommendations and further discussion

Overall, the total cost of the subsequent top-up program has been less compared to the original forecast, and we are seeing some potential improvements in funding amount and frequency for topup users. There are some confusing and opposing results (see the [Caveats section](#caveats)), and therefore all outputs should be taken with a grain of salt.

What do we do now? We are currently planning to increase the recurring topup fee from 1% to 3% around the end of October. We could proceed with that, or if we’re willing to eat the program cost for now we could keep the fee at 1%. If we were to do an A/B test with new users we could redo this analysis with much higher accuracy, as well as better understand whether Stripe recurring topup is cannibalizing any other deposit methods; we could then also better weigh the costs and benefits associated with this funding method.

## Caveats

**THIS WAS NOT AN A/B TEST**. All analysis here, with the exception of *Stripe Radar Risk Scores*, was done as a pre/post analysis. Some analysis required covering large amounts of time (see the *lapse rate* analysis). This means our analysis could be influenced by a variety of factors, including:

 - changes in market sentiment
 - differences between cohorts
 - changes to the unemployment rate (unfortunately a major factor this summer)
 - changes in fraudulent user behavior (we filtered out all confirmed fraud cases, but we might not have caught all of it)
 - marketing/acquisition efforts that happened at different periods
 - etc...

# Analysis {.tabset .tabset-fade}

## Incremental Funding Rate

Data is within `r interval` days of KYC Complete for a `r cohort` day cohort 

```{r, echo=FALSE, message=FALSE}
# translate to boolean for the rate analysis
users[!is.na(users$first_txn)]$first_txn <- 1
users[is.na(users$first_txn)]$first_txn <- 0
users$first_txn <- as.integer(users$first_txn)

control <- users[category=='pre',]$first_txn
treatment <- users[category=='post',]$first_txn

AB1 <- bayesTest(treatment, control, priors = c('alpha' = 1, 'beta' = 1), n_samples = 1e5, distribution = 'bernoulli')

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px;}
</style>
<div class = "blue">
**These results `r ifelse(abs(1-summary(AB1)$probability$Probability)<5 & !(summary(AB1)$interval$Probability[1] < 0 & 0 < summary(AB1)$interval$Probability[2]), "are", "are NOT")` significant**
</div>

estimated lift: `r percent(mean(c(summary(AB1)$interval$Probability)))`

```{r, echo=FALSE, message=FALSE}

kable(users[, .(min_kyc=min(kyc_first_completed),
          max_kyc=max(kyc_first_completed)), by=.(category)]) %>%
  kable_styling(full_width = F)

kable(data.frame("Variants"=c("pre_launch","post_launch"), 
           "Users"=c(length(control), length(treatment)), 
           "Outcomes"=c(sum(control), sum(treatment)),
           "Funding Rate"=c(sum(control)/length(control), sum(treatment)/length(treatment)))) %>%
  kable_styling(full_width = F)
```

### 90% Confidence Interval:

```{r, echo=FALSE, message=FALSE}
summary(AB1)$interval$Probability

```

```{r, echo=FALSE, message=FALSE}
# generate plots
images <- plot(AB1)
levels(images$posteriors$Probability$data$recipe) <- as.factor(c("post_launch","pre_launch"))
images$posteriors$Probability + ggtitle("Outcome Distribution")
images$samples$Probability + ggtitle("Likelihood of Improvement")
```

## Stripe Radar Risk Scores

for all topup txns after `r start.date`
```{r, echo=FALSE, message=FALSE}
transaction_risk <- user_transactions[num>0 & !is.na(stripe_radar_risk_score) & stripe_radar_risk_score != 'null',]
transaction_risk$stripe_radar_risk_score <- as.integer(transaction_risk$stripe_radar_risk_score)

           
risk_score_results <-  wilcox.test(transaction_risk[topup_type=='first',]$stripe_radar_risk_score, 
            transaction_risk[topup_type=='recurring',]$stripe_radar_risk_score, 
            alternative=c("two.sided"), 
            conf.level=.9, 
            correct=TRUE, 
            paired = FALSE)
```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px;}
</style>
<div class = "blue">
Differences in average risk scores for first vs recurring topups `r ifelse(risk_score_results$p.value < 0.05, "are", "are NOT")` statistically significant
</div>

```{r, echo=FALSE, message=FALSE}

# average risk scores
kable(transaction_risk[complete.cases(transaction_risk$stripe_radar_risk_score),][, .(avg_risk_score = mean(stripe_radar_risk_score)),by = .(topup_type)]) %>%
  kable_styling(full_width = F)

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(transaction_risk, aes(x=stripe_radar_risk_score, fill=topup_type)) +
  geom_density(alpha=.65)+
  labs(title = "Distribution of Stripe Radar Risk Scores")

```

## Funding Amounts {.tabset .tabset-fade .tabset-pills}

Data is within `r interval` days of KYC Complete for a `r cohort` day cohort

```{r, echo=FALSE, message=FALSE}
kable(users[, .(min_kyc=min(kyc_first_completed),
          max_kyc=max(kyc_first_completed)), by=.(category)]) %>%
  kable_styling(full_width = F)
```

### Overall Funding

```{r, echo=FALSE, message=FALSE}
# use log to smooth out the amounts because users tend to peg their deposits at certain amounts (and/or we set limits on topup funding amounts)
users$log_amount <- log(users$amount)
overall_funding_amount_results <- wilcox.test(remove_outliers(users[category=='pre' & first_txn==1,]$log_amount), 
            remove_outliers(users[category=='post' & first_txn==1,]$log_amount), 
            alternative=c("two.sided"), 
            conf.level=.9, 
            correct=TRUE, 
            paired = FALSE)

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px;}
</style>
<div class = "blue">
Differences in total funding amounts per user from before to after product launch `r ifelse(overall_funding_amount_results$p.value < 0.05, "appear to be", "do NOT appear to be")` statistically significant
</div>

 
```{r, echo=FALSE, message=FALSE, warning=FALSE}
kable(users[first_txn==1, .(avg_total_amount_per_user = mean(amount), users=.N),by = .(category)][order(category),] ) %>%
  kable_styling(full_width = F)

ggplot(users[amount>0 & first_txn==1,], aes(x=amount, fill=category)) +
  geom_density(alpha=.65)+
  labs(title = "Distribution of 14-day overall deposits")+
  xlim(0,2000)
```
 
### Topup Users Only

```{r, echo=FALSE, message=FALSE}
topup_funding_amount_results <- wilcox.test(users[category=='pre' & !is.na(first_topup),]$log_amount, 
            users[category=='post' & !is.na(first_topup),]$log_amount, 
            alternative=c("two.sided"), 
            conf.level=.9, 
            correct=TRUE, 
            paired = FALSE)

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px;}
</style>
<div class = "blue">
Differences in total funding amounts per user from before to after product launch `r ifelse(topup_funding_amount_results$p.value < 0.05, "appear to be", "do NOT appear to be")` statistically significant
</div>

estimated overall funding lift: `r percent(users[category=='post' & !is.na(first_topup), .(amount = sum(amount))]$amount/users[category=='pre' & !is.na(first_topup), .(amount = sum(amount))]$amount - 1)`
 
```{r, echo=FALSE, message=FALSE, warning=FALSE}

# average amount per user via topup
kable(users[!is.na(first_topup), .(avg_total_topup_amount_per_user = mean(amount), users=.N),by = .(category)][order(category),]) %>%
  kable_styling(full_width = F)

ggplot(users[amount>0 & !is.na(first_topup),], aes(x=amount, fill=category)) +
  geom_density(alpha=.65)+
  labs(title = "Distribution of 14-day topup deposits")+
  xlim(0,1000)

```


## Lapse Rates

Looking at 8-week lapse rates for a `r lapse_cohort`-week cohort of users pre/post the product launch on July 22

```{r, echo=FALSE, message=FALSE}

# flag users who have made a topup transaction in their first 8 weeks
mau_topup$topup_flag <- ifelse(mau_topup$topup_user <= mau_topup$eight_weeks, 1, 0)
mau_topup[is.na(mau_topup$topup_flag),]$topup_flag <- 0

# aggregate 
mau_topup_groups <- mau_topup[,.(users=.N), by=.(mau_group,category)][order(mau_group,category),] 
mau_topup_groups <- merge(mau_topup_groups, mau_topup_groups[,.(total=sum(users)), by=.(category)], all.x=TRUE, by="category")
mau_topup_groups$rate <- mau_topup_groups$users/mau_topup_groups$total

# translate to boolean for the rate analysis
mau_topup$outcome <- ifelse(mau_topup$mau_group=='unbroken_mau',1,0)

# get outcome vectors
pre_recurring <- as.integer(mau_topup[category=='pre',]$outcome)
post_recurring <- as.integer(mau_topup[category=='post',]$outcome)

# mau_topup[!is.na(mau_topup$first_txn)]$first_txn <- 1
# mau_topup[is.na(mau_topup$first_txn)]$first_txn <- 0
# mau_topup$first_txn <- as.integer(mau_topup$first_txn)

# look at overall numbers
pre_recurring <- as.integer(pre_recurring)
post_recurring <- as.integer(post_recurring)

AB1 <- bayesTest(post_recurring, pre_recurring, priors = c('alpha' = 1, 'beta' = 1), n_samples = 1e5, distribution = 'bernoulli')

```

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px;}
</style>
<div class = "blue">
**These results `r ifelse(abs(1-summary(AB1)$probability$Probability)<5 & !(summary(AB1)$interval$Probability[1] < 0 & 0 < summary(AB1)$interval$Probability[2]), "are", "are NOT")` significant**
</div>

estimated lift: `r percent(mean(c(summary(AB1)$interval$Probability)))`

```{r, echo=FALSE, message=FALSE}


kable(mau_topup_groups)%>%
  kable_styling(full_width = FALSE)

kable(data.frame("Variants"=c("pre_launch","post_launch"), 
           "Users"=c(length(pre_recurring), length(post_recurring)), 
           "Outcomes"=c(sum(pre_recurring), sum(post_recurring)),
           "Unbroken MAU Rate"=c(sum(pre_recurring)/length(pre_recurring), sum(post_recurring)/length(post_recurring)))) %>%
  kable_styling(full_width = F)
```

### 90% Confidence Interval:

```{r, echo=FALSE, message=FALSE}
summary(AB1)$interval$Probability

```

```{r, echo=FALSE, message=FALSE}
# generate plots
images <- plot(AB1)
levels(images$posteriors$Probability$data$recipe) <- as.factor(c("post_launch","pre_launch"))
images$posteriors$Probability + ggtitle("Outcome Distribution")
images$samples$Probability + ggtitle("Likelihood of Improvement")
```


