)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 3.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 10,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual(values=color[4:10],
name = "Spaces Sepa Type",
labels = c("1+ Sepa Topup"
,"1+ Sepa Direct Debit"
,"1+ Sepa Direct Transfer")
)
ggplot(filter(piv,month >= '2022-01-01'),
aes(x=as.factor(month),
y = percent,
group=as.factor(cat),
color=as.factor(cat)
)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 5.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 10,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual(values=color[4:10],
name = "Spaces Sepa Type",
labels = c("1+ Sepa Topup"
,"1+ Sepa Direct Debit"
,"1+ Sepa Direct Transfer")
)
ggplot(filter(piv,month >= '2022-01-01'),
aes(x=as.factor(month),
y = percent,
group=as.factor(cat),
color=as.factor(cat)
)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 5.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 10,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
legend.key.size = unit(1.75, "cm"),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual(values=color[4:10],
name = "Spaces Sepa Type",
labels = c("1+ Sepa Topup"
,"1+ Sepa Direct Debit"
,"1+ Sepa Direct Transfer")
)
ggplot(filter(piv,month >= '2022-01-01'),
aes(x=as.factor(month),
y = percent,
group=as.factor(cat),
color=as.factor(cat)
)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 5.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 14,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
legend.key.size = unit(1.75, "cm"),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual(values=color[4:10],
name = "Spaces Sepa Type",
labels = c("1+ Sepa Topup"
,"1+ Sepa Direct Debit"
,"1+ Sepa Direct Transfer")
)
ggplot(filter(piv,month >= '2022-01-01'),
aes(x=as.factor(month),
y = percent,
group=as.factor(cat),
color=as.factor(cat)
)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 5.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 14,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
legend.key.size = unit(1.75, "cm"),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual(values=color[4:10],
name = "Spaces Sepa Type",
labels = c("1+ Sepa\nTopup"
,"1+ Sepa\nDirect Debit"
,"1+ Sepa\nDirect Transfer")
)
it$month <- as.Date(it$month)
piv <- as.data.frame(
it %>%
tidyr::pivot_longer(
cols = starts_with("perc"), # column name starts with string
names_to = "cat", # new column name of column names after pivot
values_to = "percent", # new column for values,
#names_prefix = "per_",
#na.rm=TRUE,
)
)
ggplot(filter(piv,month >= '2022-01-01'),
geom_point(size=2.5,
ggplot(filter(piv,month >= '2022-01-01'),
aes(x=as.factor(month),
y = percent,
group=as.factor(cat),
color=as.factor(cat)
)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 5.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 14,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
legend.key.size = unit(1.75, "cm"),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual((values=color[7:14],
ggplot(filter(piv,month >= '2022-01-01'),
aes(x=as.factor(month),
y = percent,
group=as.factor(cat),
color=as.factor(cat)
)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 5.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 14,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
legend.key.size = unit(1.75, "cm"),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual(values=color[7:14],
name = "Txn Category",
labels = c("1+ Sepa + Internal txns","1+ Sepa txns","1+ Internal txns")
)
ggplot(filter(piv,month >= '2022-01-01'),
aes(x=as.factor(month),
y = percent,
group=as.factor(cat),
color=as.factor(cat)
)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 5.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 14,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
legend.key.size = unit(1.75, "cm"),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual(values=set2,
name = "Txn Category",
labels = c("1+ Sepa + Internal txns","1+ Sepa txns","1+ Internal txns")
)
ggplot(filter(piv,month >= '2022-01-01'),
aes(x=as.factor(month),
y = percent,
group=as.factor(cat),
color=as.factor(cat)
)
) +
geom_line(size=2.0)+
geom_point(size=2.5,
#shape=23,
#fill = "#E69F00"
) +
#geom_hline(yintercept=0.5, linetype="dashed", color = "red",size=1) +
geom_text(aes(label = round(percent*100), group = cat), position = position_dodge(0.8),vjust = -0.3, size = 5.5) +
ylab("% IBAN Accounts") + xlab("Month") +
ggtitle("% IBAN Accounts w/ 1+ txns split by transaction type") +
theme(
legend.title = element_text(color = "black", size = 16),
legend.text = element_text(color = "black", size = 14,face="bold"),
axis.text.y=element_text(size=18,face="bold",angle=45
),
axis.text.x=element_text(size=18,face="bold",angle=45
),
axis.title.x = element_text(size= 16,face='bold'),
axis.title.y = element_text(size=16,face='bold'),
legend.key.size = unit(1.75, "cm"),
strip.background = element_rect(
color="black",
#fill=values,
size=2.0,
linetype="solid"),
strip.text.y = element_text(
size = 18,
#color = "red",
face = "bold"
),
strip.text.x = element_text(
size = 18,
#color = "red",
face = "bold"
)) +
scale_y_continuous(labels=scales::percent) +
#facet_grid(~act_referrer) + #theme_bw() +
scale_color_manual(values=set2,
name = "Txn Category",
labels = c("1+ Sepa \n+Internal txns","1+ Sepa\ntxns","1+ Internal\ntxns")
)
internal_txn_direction <- queryDB("
with spaces_users as (
select
COALESCE(s_m.user_created,s.user_created) as user_created,
s_m.space_id,
s.account_id,
a.activity_type,  -- spaces iban = 'SPACE_EXTERNAL_ID_ADDED'
COALESCE(s_m.role, 'OWNER') as role,
coalesce(count(case when s_m.role = 'MEMBER' then 1 end)
over (partition by s.id, s.end_ts),0) as shared_members,
start_ts, end_ts
from (select user_created, id,account_id, min(rev_timestamp) as start_ts, max(end_timestamp) as end_ts
from w_space_aud
where is_primary is false
and status = 'ACTIVE'
group by 1,2,3
) s
join w_member_aud as s_m
on s_m.space_id = s.id
and current_date between s_m.rev_timestamp and s_m.end_timestamp
and s_m.status = 'ACTIVE'
left join (select * from w_activity_log where activity_type = 'SPACE_EXTERNAL_ID_ADDED') a --spaces iban
on a.space_id = s.id
and a.created::date between s.start_ts::date and s.end_ts::date
),transfer_ids as (
select
distinct t.transfer_id
from (select * from spaces_users where activity_type = 'SPACE_EXTERNAL_ID_ADDED') s
join ag_transaction_details t
on s.account_id = t.account_id
and s.user_created = t.user_created
and t.created between s.start_ts and s.end_ts
), txns as (
select
s.user_created,
s.shared_members,
case when activity_type = 'SPACE_EXTERNAL_ID_ADDED' then 'iban_spaces'
when shared_members > 0 and activity_type is null then 'shared_spaces'
else 'regular_spaces' end as spaces_type,
s.start_ts,
s.end_ts,
t.created,
t.transfer_id,
t.account_id,
t.account_role,
t.type
from (select * from spaces_users where activity_type = 'SPACE_EXTERNAL_ID_ADDED') s
join (select *
from ag_transaction_details
where transfer_id in (select distinct transfer_id from transfer_ids)
) t
on s.user_created = t.user_created
and created between start_ts and end_ts
), piv as (
select
user_created,
transfer_id,
sum(case when account_role = 'PRIMARY' and type = 'DT' then 1 else 0 end ) as primary_dt,
sum(case when account_role = 'PRIMARY' and type = 'CT' then 1 else 0 end ) as primary_ct,
sum(case when account_role = 'SECONDARY' and type = 'DT' then 1 else 0 end ) as secondary_dt,
sum(case when account_role = 'SECONDARY' and type = 'CT' then 1 else 0 end ) as secondary_ct
from txns
group by 1,2
)
select
primary_dt,
primary_ct,
secondary_dt,
secondary_ct,
count(distinct transfer_id) as n_transfers
from piv
group by 1,2,3,4
--order by 1,2
--order by 1,7
;
","redshift-eu")
